## 消息队列

### 什么是消息队列？

我个人比较倾向于把这个中间件当做是邮局来对待，你把消息发送给邮局，指定哪些人能收到消息，邮局再把消息发送给接收人。这样做的好处就是你只要指定了发送人和消息其他的就跟你没关系了，你就可以去忙其他的事情了。



### 为什么要用消息队列？

#### 异步处理

与主业务无关的业务，可以通过发送消息然后直接返回结果，这样可以减少接口的响应时间。比如下面用用户购买一件商品的代码进行解析。

```java
private R buy(Product product, User user) {
    // 主业务逻辑
    buyProduct(product, user);
    // 其他业务逻辑
    sendMessages(product, user);

    return R.success();
}


private void buyProduct(Product product, User user) {
    // 用户扣款、商品减少库存、生成订单等主要的业务逻辑...
}

private void sendMessages(Product product, User user) {
    // 发送消息到消息队列提醒积分增长、短信、邮件提醒等。
    sendSMSMessage(product, user);
    sendEmailMessage(product, user);
    sendScoreMessage(product, user);
}


private void receiveScoreMessage(Object msg) {
    // 真正的消费端，消费消息来增长用户积分
}

private void receiveEmailMessage(Object msg) {
    // 真正的消费端，消费消息来发送下单成功邮件
}

private void receiveSMSMessage(Object msg) {
    // 真正的消费端，消费消息来发送下单成功短信
}
```

简单说一下上面的代码，在程序开发中我们为了追求效率就会使用异步方法，在单体项目中我们可以另起一个线程来执行，主方法去做其他的事情，但是在分布式环境下，我们就需要使用通知式的方法来告诉别人执行这个任务，不然我们可能就需要在短信服务端写一个接口，内容是另起一个线程来发送短信，哈哈哈开个玩笑，这样的话其实会有很多问题。这个时候就可以使用消息队列来帮我们完成这件事情。



#### 削峰填谷

继续以上一个用户购买一件商品的Demo作为例子来讲，如果我们没有使用消息队列，那么业务代码都在一个方法里，而其中部分代码并不是特别重要，甚至是和主逻辑可以分开执行的，那么执行效率当然会大大降低。当同一时间购买商品的用户过多，那么会让其他用户进行等待。如果有一个流量比较大的秒杀活动，系统使用微服务架构，商品订单等重要模块多个服务集群，而短信邮件通知服务只是单体或较少集群。当一批用户调用下单逻辑，理想情况下可能只是因为同步调用短信邮件等附加服务拖慢系统速度，恶劣情况下可能会打垮短信邮件服务，这样则会影响整个业务逻辑。如果引入了消息队列只需要发送消息到消息队列，短信邮件服务按顺序逐条消费消息通知。这样既提高了系统速度又降低了服务宕机风险。



#### 降低系统耦合性

上面其实就已经说明了这块，微服务间各司其职，完全使用同步方式则会因为非主要服务宕机来导致整个业务异常。



### 使用消息队列带来的问题？





### JMS VS AMQP





### 常见消息队列对比



